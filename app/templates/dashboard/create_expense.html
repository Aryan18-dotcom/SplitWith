{% extends "dashboard/base.html" %}
{% block title %}Add Expense{% endblock %}

{% block content %}
<style>
  .hidden {
    display: none;
  }

  .error {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .card {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
    border: 1px solid #f0f0f0;
  }

  .input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
  }

  .btn {
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-primary {
    background: #2563eb;
    color: #fff;
    border: none;
  }

  .btn-success {
    background: #16a34a;
    color: #fff;
    border: none;
  }

  .small-label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .split-box {
    background: #fbfbfc;
    padding: 14px;
    border-radius: 8px;
    border: 1px solid #eef2f7;
  }
</style>

<div class="max-w-3xl mx-auto mt-8">

  <!-- STEP 1 -->
  <div id="step1" class="card {% if form_step != 1 %}hidden{% endif %}">
    <h3 class="text-2xl font-semibold mb-1">Create New Expense</h3>
    <p class="text-gray-500 mb-4">Choose group or user for the expense</p>

    <div id="step1Error" class="error hidden"></div>

    <div class="mb-4">
      <label class="small-label">Select Group</label>
      <select id="groupSelect" class="input">
        <option value>-- Select Group --</option>
        {% for g in groups %}
        <option value="{{ g._id }}"
          data-members='{{ (g.group_members_objects if g.group_members_objects is defined else g.group_members) | tojson }}'>
          {{ g.group_title }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="text-center my-3 text-sm text-gray-400 font-semibold">OR</div>

    <div class="mb-4">
      <label class="small-label">Select User</label>
      <select id="userSelect" class="input">
        <option value>-- Select User --</option>
        {% for u in users %}
        {% if u._id != current_user._id %}
        <option value="{{ u._id }}" data-username="{{ u.username }}">{{
          u.username }}</option>
        {% endif %}
        {% endfor %}
      </select>
    </div>

    <button id="continueBtn" class="btn btn-primary w-full">Continue</button>
  </div>

  <!-- STEP 2 -->
  <div id="step2" class="card mt-6 {% if form_step != 2 %}hidden{% endif %}">
    <form id="expenseForm" method="POST" action="{{ url_for('expense.create_expense') }}">
      <input type="hidden" name="group_id" id="group_id">
      <input type="hidden" name="member_id" id="member_id">
      <input type="hidden" name="split_type" id="dynamicSplitType">

      <h3 class="text-2xl font-semibold mb-1">Create Expense <span id="subTitleContext"></span></h3>
      <p id="subTitle" class="text-gray-500 mb-4">Fill details below</p>

      <label class="small-label">Title</label>
      <input name="title" class="input mb-3" required>

      <label class="small-label">Description</label>
      <textarea name="description" class="input mb-3" rows="2"></textarea>

      <label class="small-label">Amount</label>
      <input type="number" name="amount" id="amount" step="0.01" min="0.01" class="input mb-4" required>

      <div id="groupSplitBox">

        <label class="small-label">Split Type</label>
        <select id="splitType" class="input mb-3">
          <option value="paid_by_you">You Paid Full</option>
          <option value="equal">Split Equally</option>
          <option value="paid_by_other">Other Paid Full</option>
          <option value="custom">Custom Split</option>
        </select>

        <div id="paidByOtherBox" class="hidden mb-3">
          <label class="small-label">Who Paid?</label>
          <select name="paid_by" id="paidBySelect" class="input"></select>
        </div>

        <div id="customSplitBox" class="hidden split-box">
          <h4 class="font-semibold mb-2">Custom Share Amounts</h4>
          <div id="customArea"></div>
          <div id="customTotalError" class="error hidden"></div>
        </div>
      </div>

      <button type="submit" class="btn btn-success w-full mt-4">Create
        Expense</button>
    </form>
  </div>

</div>

{% block external_script %}
<script>
  (function () {
    // Safe DOM getters
    const $ = id => document.getElementById(id);
    const groupSelect = $('groupSelect');
    const userSelect = $('userSelect');
    const continueBtn = $('continueBtn');
    const step1 = $('step1');
    const step2 = $('step2');
    const group_id_in = $('group_id');
    const member_id_in = $('member_id');
    const splitType = $('splitType');
    const paidBySelect = $('paidBySelect');
    const customArea = $('customArea');
    const subTitleContext = $('subTitleContext');
    const dynamicSplitType = $('dynamicSplitType');
    const customTotalError = $('customTotalError');
    const expenseForm = $('expenseForm');

    // Build usersMap from server 'users'
    const usersMap = {};
    {% for u in users %}
    usersMap["{{ u._id }}"] = { "username": "{{ u.username }}" };
    {% endfor %}

    const currentUserId = "{{ current_user._id|default(current_user.id|default('')) }}";
    const currentUserName = "{{ current_user.username|default('You') }}";

    function parseJSONSafe(s) {
      try { return JSON.parse(s); } catch (e) { return []; }
    }

    function normalizeMembers(raw) {
      const out = [];
      if (!raw || !Array.isArray(raw)) return out;

      raw.forEach(m => {
        if (m && typeof m === 'object') {
          const id = m._id || m.id || (m['$oid'] || null);
          const username = m.username || m.name || usersMap[String(id)]?.username || String(id);
          out.push({ _id: String(id), username });
        } else if (typeof m === 'string' || typeof m === 'number') {
          const id = String(m);
          const username = usersMap[id]?.username || id;
          out.push({ _id: id, username });
        }
      });

      return out;
    }

    function resetCustomArea() {
      if (!customArea) return;
      customArea.innerHTML = '';
    }

    function fillPaidByAndCustom(members) {
      if (!paidBySelect || !customArea) return;
      paidBySelect.innerHTML = '';
      customArea.innerHTML = '';
      members.forEach(m => {
        const label = (m._id === currentUserId) ? `${currentUserName} (You)` : m.username;
        paidBySelect.insertAdjacentHTML('beforeend', `<option value="${m._id}">${label}</option>`);
        customArea.insertAdjacentHTML('beforeend', `
        <div class="mb-3">
          <label class="small-label">${label}</label>
          <input type="number" step="0.01" name="share_${m._id}" value="0.00" class="input share-input">
          <input type="hidden" name="pay_${m._id}" value="0">
        </div>`);
      });
    }

    if (continueBtn) {
      continueBtn.addEventListener('click', function (e) {
        e.preventDefault();
        const groupVal = groupSelect ? groupSelect.value : '';
        const userVal = userSelect ? userSelect.value : '';
        const step1Error = $('step1Error');
        if (step1Error) { step1Error.classList.add('hidden'); step1Error.innerText = ''; }

        resetCustomArea();
        if (splitType) splitType.value = 'paid_by_you';
        if (dynamicSplitType) dynamicSplitType.value = 'paid_by_me';
        if (subTitleContext) subTitleContext.innerHTML = '';

        if (groupVal && userVal) {
          if (step1Error) { step1Error.innerText = 'Select ONLY group OR user, not both.'; step1Error.classList.remove('hidden'); }
          return;
        }
        if (!groupVal && !userVal) {
          if (step1Error) { step1Error.innerText = 'Please select a group or user.'; step1Error.classList.remove('hidden'); }
          return;
        }

        if (group_id_in) group_id_in.value = groupVal || '';
        if (member_id_in) member_id_in.value = userVal || '';

        let members = [];
        if (userVal) {
          // Personal
          const opt = userSelect.querySelector(`option[value="${userVal}"]`);
          const otherName = opt ? (opt.dataset.username || opt.textContent.trim()) : userVal;
          members = [
            { _id: String(currentUserId), username: String(currentUserName) },
            { _id: String(userVal), username: String(otherName) }
          ];
          if (subTitleContext) subTitleContext.innerHTML = `<div class="inline-block bg-blue-50 text-blue-700 px-3 py-1 rounded">${otherName} (Personal)</div>`;
        } else {
          // Group
          const opt = groupSelect.querySelector(`option[value="${groupVal}"]`);
          let rawMembers = [];
          if (opt && opt.dataset && opt.dataset.members) {
            rawMembers = parseJSONSafe(opt.dataset.members);
          }
          members = normalizeMembers(rawMembers);

          // Ensure current user is included with correct username
          const currentUserObj = { _id: String(currentUserId), username: String(currentUserName) };
          if (!members.some(m => m._id === currentUserObj._id)) {
            members.unshift(currentUserObj);
          }

          const groupName = opt ? (opt.textContent.trim() || 'Group') : 'Group';
          if (subTitleContext) subTitleContext.innerHTML = `For: ${groupName}`;
        }

        fillPaidByAndCustom(members);

        if (step1) step1.classList.add('hidden');
        if (step2) step2.classList.remove('hidden');

        if (splitType) {
          const ev = new Event('change');
          splitType.dispatchEvent(ev);
        }
      });
    }

    if (splitType) {
      splitType.addEventListener('change', function () {
        const v = splitType.value;
        if ($('paidByOtherBox')) $('paidByOtherBox').classList.add('hidden');
        if ($('customSplitBox')) $('customSplitBox').classList.add('hidden');
        if (customTotalError) { customTotalError.classList.add('hidden'); customTotalError.innerText = ''; }

        document.querySelectorAll('.share-input').forEach(i => i.value = '0.00');

        if (v === 'paid_by_other') {
          if ($('paidByOtherBox')) $('paidByOtherBox').classList.remove('hidden');
          if (dynamicSplitType) dynamicSplitType.value = 'paid_by_other';
        } else if (v === 'paid_by_you') {
          if (dynamicSplitType) dynamicSplitType.value = 'paid_by_me';
        } else if (v === 'custom') {
          if ($('customSplitBox')) $('customSplitBox').classList.remove('hidden');
          if (dynamicSplitType) dynamicSplitType.value = 'custom';
        } else {
          if (dynamicSplitType) dynamicSplitType.value = 'equal';
        }
      });
    }

    if (expenseForm) {
      expenseForm.addEventListener('submit', function (e) {
        try {
          if (!dynamicSplitType || dynamicSplitType.value !== 'custom') return;
          const amountInput = $('amount');
          if (!amountInput || !amountInput.value || parseFloat(amountInput.value) <= 0) {
            alert('Enter a valid amount.');
            e.preventDefault();
            return;
          }
          const amount = parseFloat(amountInput.value) || 0;
          let total = 0;
          document.querySelectorAll("input[name^='share_']").forEach(i => {
            total += parseFloat(i.value) || 0;
          });
          if (Math.abs(total - amount) > 0.01) {
            e.preventDefault();
            if (customTotalError) {
              customTotalError.innerText = `Custom shares must total ${amount.toFixed(2)} — current ${total.toFixed(2)}`;
              customTotalError.classList.remove('hidden');
            } else {
              alert(`Custom shares must total ${amount.toFixed(2)} — current ${total.toFixed(2)}`);
            }
          }
        } catch (err) {
          console.error('Validation error', err);
          e.preventDefault();
          alert('Validation failed. See console for details.');
        }
      });
    }

  })();
</script>

{% endblock %}

{% endblock %}