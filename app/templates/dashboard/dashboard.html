{% extends "dashboard/base.html" %}
{% block title %}Dashboard - SplitWith {% endblock %}

{% macro currency(value) %}
{{ value | currency }}
{% endmacro %}

{% macro datetimeformat(value) %}
{{ value | datetimeformat }}
{% endmacro %}

{% block content %}

<section class="p-6 space-y-10">

  <!-- TOP 3 CARDS -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="top-cards">
    <div class="card p-6 rounded-2xl shadow-lg bg-white border transform translate-y-6">
      <div class="text-sm font-semibold text-gray-600">Net Balance</div>
      <div
        class="mt-3 text-4xl font-extrabold {% if total_balance > 0 %}text-green-600{% elif total_balance < 0 %}text-red-600{% else %}text-gray-800{% endif %}">
        {{ total_balance | currency }}
      </div>
    </div>

    <div class="card p-6 rounded-2xl shadow-lg bg-white border transform translate-y-6">
      <div class="text-sm font-semibold text-gray-600">You Are Owed</div>
      <div class="mt-3 text-4xl font-extrabold text-green-600">
        {{ total_owed | currency }}
      </div>
    </div>

    <div class="card p-6 rounded-2xl shadow-lg bg-white border transform translate-y-6">
      <div class="text-sm font-semibold text-gray-600">You Owe</div>
      <div class="mt-3 text-4xl font-extrabold text-red-600">
        {{ total_owes | currency }}
      </div>
    </div>
  </div>

  <!-- Recent Transactions + Top 3 Expenses -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg border">
      <div class="flex justify-between items-center mb-4">
        <div class="text-xl font-bold">Recent Transactions</div>
        <div class="text-gray-500 text-sm">Last 10</div>
      </div>

      <div class="space-y-4" id="recent-transactions-list">
        {% if transactions %}
        {% for tx in transactions %}
        <div
          class="tx-item p-4 rounded-xl bg-gray-50 border-l-4 border-gray-200 hover:shadow-md transform opacity-0 translate-y-4">
          <div class="flex justify-between">
            <div>
              <a href="{{ url_for('expense.view_expense', expense_id=tx.transection_id) }}" class="font-semibold text-gray-800 hover:text-blue-600 cursor-pointer">
                {{ tx.title }}
              </a>
              <div class="text-sm text-gray-500 mt-1">{{ tx.group_name }} Â· {{ tx.date | datetimeformat }}</div>
              {% if tx.description %}
              <div class="text-gray-600 text-sm italic mt-1">{{ tx.description }}</div>
              {% endif %}
            </div>
            <div class="text-right">
              <div
                class="font-bold text-lg {% if tx.payer_id == current_user_id %}text-green-600{% else %}text-red-600{% endif %}">
                {{ tx.amount | currency }}
              </div>
              <div class="text-xs text-gray-500 mt-1">{% if tx.payer_id == current_user_id %}Paid{% else %}Owed{% endif
                %}</div>
            </div>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center p-8 text-gray-500 bg-gray-50 rounded-xl">ðŸŽ‰ All clear! No recent transactions.</div>
        {% endif %}
      </div>
    </div>

    <!-- Top 3 Expenses (aside) -->
    <div class="bg-white p-6 rounded-2xl shadow-lg border">
      <div class="text-xl font-bold mb-4">Top Expenses (This Month)</div>
      <div class="space-y-3" id="top-expenses">
        {% for t in transactions[:3] %}
        <div class="p-3 rounded-md bg-gray-50 transform opacity-0 translate-x-6">
          <div class="flex justify-between">
            <div class="text-sm font-medium">{{ t.title }}</div>
            <div class="font-semibold">{{ t.amount | currency }}</div>
          </div>
          <div class="text-xs text-gray-500 mt-1">{{ t.group_name }}</div>
        </div>
        {% endfor %}
        {% if transactions|length == 0 %}
        <div class="text-gray-500 text-sm">No expenses yet.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Most Active Groups -->
  <div class="bg-white p-6 rounded-2xl shadow-lg border">
    <div class="flex justify-between items-center mb-4">
      <div class="text-xl font-bold">Most Active Groups</div>
      <div class="text-sm text-gray-500">Top 3</div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="active-groups">
      {% if active_groups %}
      {% for g in active_groups %}
      <div class="group-card p-4 rounded-xl bg-gray-50 transform opacity-0 scale-95">
        <div class="flex items-center justify-between">
          <div>
            <div class="font-semibold">{{ g.group_name }}</div>
            <div class="text-xs text-gray-500 mt-1">Members: {{ g.members }} â€¢ Expenses: {{ g.expense_count }}</div>
          </div>
          <div class="text-sm font-bold">{{ g.balance | currency }}</div>
        </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="text-gray-500">No active groups yet.</div>
      {% endif %}
    </div>
  </div>

  <!-- Monthly Expense Bar Chart -->
  <div class="bg-white p-6 rounded-2xl shadow-lg border">
    <div class="text-xl font-bold mb-4">Monthly Expense Overview</div>
    <canvas id="monthlyBarChart" height="120"></canvas>
  </div>

  <!-- Recent Expenses (detailed list) -->
  <div class="bg-white p-6 rounded-2xl shadow-lg border">
    <div class="text-xl font-bold mb-4">Recent Expenses</div>

    {% if recent_expenses %}
    <div class="space-y-3" id="recent-expenses-list">
      {% for e in recent_expenses %}
      <div class="p-4 rounded-lg border transform opacity-0 translate-y-6">
        <div class="flex justify-between">
          <div>
            <div class="font-semibold">{{ e.title }}</div>
            <!-- Group Name + Date -->
            <div class="text-xs text-gray-500 mt-0.5">
              {% if e.group_details %}
              <a href="{{ url_for('group.group_details', group_id=e.group_details._id) }}"
                class="text-blue-600 underline font-medium">
                {{ e.group_details.group_title }}
              </a>
              {% else %}
              Unknown Group
              {% endif %}
              â€¢ {{ e.created_at | datetimeformat }}
            </div>
            {% if e.description %}
            <div class="text-sm text-gray-600 italic mt-1">{{ e.description }}</div>
            {% endif %}
          </div>
          <div class="font-bold text-blue-600">{{ e.amount | currency }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-gray-500 text-center py-6">No recent expenses.</div>
    {% endif %}
  </div>

  <!-- CTA Buttons -->
  <div class="flex flex-wrap gap-6 justify-center pt-8" id="cta-buttons">

    <!-- Create Group -->
    <a href="{{ url_for('group.create_group') }}"
      class="cta group px-7 py-4 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-md hover:shadow-xl transform transition-all duration-300 hover:-translate-y-1 opacity-0 translate-y-8 flex items-center gap-3">

      <!-- SVG Icon -->
      <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform duration-300" fill="none"
        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 5v14m-7-7h14" />
      </svg>

      <span class="font-semibold tracking-wide">Create Group</span>
    </a>

    <!-- Add Expense -->
    <a href="{{ url_for('expense.create_expense') }}"
      class="cta group px-7 py-4 rounded-2xl bg-gradient-to-r from-green-500 to-green-600 text-white shadow-md hover:shadow-xl transform transition-all duration-300 hover:-translate-y-1 opacity-0 translate-y-8 flex items-center gap-3">

      <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform duration-300" fill="none"
        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 8v8m-4-4h8" />
        <circle cx="12" cy="12" r="9" />
      </svg>

      <span class="font-semibold tracking-wide">Add Expense</span>
    </a>

    <!-- Monthly Report -->
    <a href=""
      class="cta group px-7 py-4 rounded-2xl bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-md hover:shadow-xl transform transition-all duration-300 hover:-translate-y-1 opacity-0 translate-y-8 flex items-center gap-3">

      <svg class="w-6 h-6 text-white group-hover:scale-110 transition-transform duration-300" fill="none"
        stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 3v18h18" />
        <path d="M7 14l3-3l4 4l6-6" />
      </svg>

      <span class="font-semibold tracking-wide">View Monthly Report</span>
    </a>

  </div>


</section>

{% endblock %}

{% block extra_scripts %}
{{ super() }}

<script>
  // ---------- Chart.js Bar chart ----------
  const ctx = document.getElementById('monthlyBarChart').getContext('2d');

  const monthsData = {{ months | tojson | safe }};
  const expenseData = {{ monthly_expenses | tojson | safe }};

  // ---- Fix: Provide safe fallback if arrays are empty ----
  const finalMonths = monthsData.length ? monthsData : ["Jan", "Feb", "Mar", "Apr", "May", "Jun"];
  const finalExpenses = expenseData.length ? expenseData : [0, 0, 0, 0, 0, 0];

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: finalMonths,
      datasets: [{
        label: 'Expenses',
        data: finalExpenses,
        borderRadius: 6,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });


  // ---------- GSAP animations ----------
  window.addEventListener('DOMContentLoaded', () => {
    // Animate top cards (stagger)
    gsap.fromTo("#top-cards .card",
      { opacity: 0, y: 20, scale: 0.98 },
      { opacity: 1, y: 0, scale: 1, duration: 0.6, stagger: 0.12, ease: "easeIn" }
    );

    // Recent transactions
    gsap.fromTo("#recent-transactions-list .tx-item",
      { opacity: 0, y: 16 },
      { opacity: 1, y: 0, duration: 0.5, stagger: 0.08, ease: "power3.out", delay: 0.25 }
    );

    // Top expenses aside
    gsap.fromTo("#top-expenses > div",
      { opacity: 0, x: 20 },
      { opacity: 1, x: 0, duration: 0.5, stagger: 0.08, ease: "power3.out", delay: 0.45 }
    );

    // Active groups
    gsap.fromTo("#active-groups .group-card",
      { opacity: 0, scale: 0.96 },
      { opacity: 1, scale: 1, duration: 0.45, stagger: 0.12, ease: "back.out(1.2)", delay: 0.25 }
    );

    // Recent expenses list
    gsap.fromTo("#recent-expenses-list > div",
      { opacity: 0, y: 20 },
      { opacity: 1, y: 0, duration: 0.5, stagger: 0.08, ease: "power3.out", delay: 0.35 }
    );

    // CTAs
    gsap.fromTo("#cta-buttons .cta",
      { opacity: 0, y: 24, scale: 0.98 },
      { opacity: 1, y: 0, scale: 1, duration: 0.5, stagger: 0.12, ease: "elastic.out(1, .6)", delay: 0.6 }
    );
  });
</script>
{% endblock %}